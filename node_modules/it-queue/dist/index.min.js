(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ItQueue = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ItQueue=(()=>{var z=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var V=(n,t)=>{for(var e in t)z(n,e,{get:t[e],enumerable:!0})},$=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of R(t))!O.call(n,i)&&i!==e&&z(n,i,{get:()=>t[i],enumerable:!(r=F(t,i))||r.enumerable});return n};var G=n=>$(z({},"__esModule",{value:!0}),n);var U={};V(U,{Queue:()=>k});var h=class extends Error{static name="AbortError";name="AbortError";constructor(t="The operation was aborted",...e){super(t,...e)}};function g(){let n={};return n.promise=new Promise((t,e)=>{n.resolve=t,n.reject=e}),n}var w=class{buffer;mask;top;btm;next;constructor(t){if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){let t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}},m=class{size;hwm;head;tail;constructor(t={}){this.hwm=t.splitLimit??16,this.head=new w(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){let e=this.head;this.head=e.next=new w(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){let e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}};var T=class extends Error{type;code;constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}};function M(n={}){return Y(e=>{let r=e.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Y(n,t){t=t??{};let e=t.onEnd,r=new m,i,o,a,l=g(),u=async()=>{try{return r.isEmpty()?a?{done:!0}:await new Promise((s,f)=>{o=y=>{o=null,r.push(y);try{s(n(r))}catch(p){f(p)}return i}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{l.resolve(),l=g()})}},b=s=>o!=null?o(s):(r.push(s),i),v=s=>(r=new m,o!=null?o({error:s}):(r.push({error:s}),i)),E=s=>{if(a)return i;if(t?.objectMode!==!0&&s?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return b({done:!1,value:s})},c=s=>a?i:(a=!0,s!=null?v(s):b({done:!0})),q=()=>(r=new m,c(),{done:!0}),C=s=>(c(s),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:u,return:q,throw:C,push:E,end:c,get readableLength(){return r.size},onEmpty:async s=>{let f=s?.signal;if(f?.throwIfAborted(),r.isEmpty())return;let y,p;f!=null&&(y=new Promise((H,Q)=>{p=()=>{Q(new T)},f.addEventListener("abort",p)}));try{await Promise.race([l.promise,y])}finally{p!=null&&f!=null&&f?.removeEventListener("abort",p)}}},e==null)return i;let d=i;return i={[Symbol.asyncIterator](){return this},next(){return d.next()},throw(s){return d.throw(s),e!=null&&(e(s),e=void 0),{done:!0}},return(){return d.return(),e!=null&&(e(),e=void 0),{done:!0}},push:E,end(s){return d.end(s),e!=null&&(e(s),e=void 0),i},get readableLength(){return d.readableLength},onEmpty:s=>d.onEmpty(s)},i}var x=class extends EventTarget{#t=new Map;constructor(){super()}listenerCount(t){let e=this.#t.get(t);return e==null?0:e.length}addEventListener(t,e,r){super.addEventListener(t,e,r);let i=this.#t.get(t);i==null&&(i=[],this.#t.set(t,i)),i.push({callback:e,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(t,e,r){super.removeEventListener(t.toString(),e??null,r);let i=this.#t.get(t);i!=null&&(i=i.filter(({callback:o})=>o!==e),this.#t.set(t,i))}dispatchEvent(t){let e=super.dispatchEvent(t),r=this.#t.get(t.type);return r==null||(r=r.filter(({once:i})=>!i),this.#t.set(t.type,r)),e}safeDispatchEvent(t,e={}){return this.dispatchEvent(new CustomEvent(t,e))}};async function L(n,t,e,r){let i=new h(r?.errorMessage);r?.errorCode!=null&&(i.code=r.errorCode);let o=r?.errorEvent??"error";return e?.aborted===!0?Promise.reject(i):new Promise((a,l)=>{function u(){P(e,"abort",E),P(n,t,b),P(n,o,v)}let b=c=>{try{if(r?.filter?.(c)===!1)return}catch(q){u(),l(q);return}u(),a(c)},v=c=>{if(u(),c instanceof Error){l(c);return}l(c.detail??r?.error??new Error(`The "${r?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},E=()=>{u(),l(i)};D(e,"abort",E),D(n,t,b),D(n,o,v)})}function D(n,t,e){n!=null&&(j(n)?n.addEventListener(t,e):n.addListener(t,e))}function P(n,t,e){n!=null&&(j(n)?n.removeEventListener(t,e):n.removeListener(t,e))}function j(n){return typeof n.addEventListener=="function"&&typeof n.removeEventListener=="function"}var S=class extends Error{static name="QueueFullError";constructor(t="The queue was full"){super(t),this.name="QueueFullError"}};function B(n){return n.reason}async function _(n,t,e){if(t==null)return n;let r=e?.translateError??B;if(t.aborted)return n.catch(()=>{}),Promise.reject(r(t));let i;try{return await Promise.race([n,new Promise((o,a)=>{i=()=>{a(r(t))},t.addEventListener("abort",i)})])}finally{i!=null&&t.removeEventListener("abort",i)}}var A=class{deferred;signal;constructor(t){this.signal=t,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new h)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function J(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var I=class{id;fn;options;recipients;status;timeline;controller;constructor(t,e){this.id=J(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,r)=>e&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new h),this.cleanup())}async join(t={}){let e=new A(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let t=await _(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}};function N(n,t){let e,r=function(){let i=function(){e=void 0,n()};clearTimeout(e),e=setTimeout(i,t)};return r.start=()=>{},r.stop=()=>{clearTimeout(e)},r}var k=class extends x{concurrency;maxSize;queue;pending;sort;autoStart;constructor(t={}){super(),this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=t.autoStart??!0,this.sort=t.sort,this.queue=[],this.emitEmpty=N(this.emitEmpty.bind(this),1),this.emitIdle=N(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let e of this.queue)if(e.status==="queued"){t=e;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let e=0;e<this.queue.length;e++)if(this.queue[e]===t){this.queue.splice(e,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(t,e){if(e?.signal?.throwIfAborted(),this.size===this.maxSize)throw new S;let r=new I(t,e);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(e).then(i=>(this.safeDispatchEvent("success",{detail:{job:r,result:i}}),i)).catch(i=>{if(r.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===r){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new h)}),this.clear()}async onEmpty(t){this.size!==0&&await L(this,"empty",t?.signal)}async onSizeLessThan(t,e){this.size<t||await L(this,"next",e?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await L(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let e=M({objectMode:!0}),r=u=>{u!=null?this.abort():this.clear(),e.end(u)},i=u=>{u.detail!=null&&e.push(u.detail.result)},o=u=>{r(u.detail.error)},a=()=>{r()},l=()=>{r(new h("Queue aborted"))};this.addEventListener("success",i),this.addEventListener("failure",o),this.addEventListener("idle",a),t?.signal?.addEventListener("abort",l);try{yield*e}finally{this.removeEventListener("success",i),this.removeEventListener("failure",o),this.removeEventListener("idle",a),t?.signal?.removeEventListener("abort",l),r()}}};return G(U);})();
return ItQueue}));
//# sourceMappingURL=index.min.js.map
